#!/usr/bin/env node

const child = require('child_process')
const fs = require('fs')
const path = require('path')

const version = process.argv[2]
if (!version) {
  console.error(
    'You must supply a version.\nUsage ./update-package-versions [version]'
  )
  process.exit(1)
}

/**
 * Iterates over Redwood dependencies in package.json files and updates the version.
 */
const updatePackageVersion = (pkgPath, version, search = '@redwoodjs/') => {
  const pkg = JSON.parse(
    fs.readFileSync(path.join(pkgPath, 'package.json'), 'utf-8')
  )

  if (pkg.dependencies) {
    for (const depName of Object.keys(pkg.dependencies).filter((x) =>
      x.startsWith(search)
    )) {
      console.log(
        `Updating ${depName}: ${pkg.dependencies[depName]} -> ^${version}`
      )
      pkg.dependencies[depName] = `^${version}`
    }
  }
  if (pkg.devDependencies) {
    for (const depName of Object.keys(pkg.devDependencies).filter((x) =>
      x.startsWith(search)
    )) {
      console.log(
        `Updating ${depName}: ${pkg.devDependencies[depName]} -> ^${version}`
      )
      pkg.devDependencies[depName] = `^${version}`
    }
  }

  fs.writeFileSync(
    path.join(pkgPath, 'package.json'),
    JSON.stringify(pkg, undefined, 2)
  )
}

const cwd = path.join(__dirname, '../')
child.execSync(['yarn lerna version', version, '--force-publish'], { cwd })

const templatePath = path.join(cwd, 'packages/create-redwood-app/template')

updatePackageVersion(templatePath, version)
updatePackageVersion(path.join(templatePath, 'api'), version)
updatePackageVersion(path.join(templatePath, 'web'), version)

child.execSync(['yarn install'], { cwd })
